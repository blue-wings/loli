<include file="Public:header" />
<div class="panel">
	<div align="left">
		<fieldset class="fieldset">
			<legend>查询条件</legend>
			<form name="myform" id="myform" action="__ACTION__" method="GET">
				用户账号：<input id='email' name='email' type='text' value='{$Think.get.email}'>
				用户ID：<input id='userid' name='userid' type='text' value='{$Think.get.userid}'>
				联系人：<input id='linkman' name='linkman' type='text' value='{$Think.get.linkman}'>
				昵称：<input id='nickname' name='nickname' type='text' value='{$Think.get.nickname}'><br><br/>
				邀请人查询:<input type="text" name="invite" value="{$Think.get.invite}">
				手机号：<input id='telphone' name='telphone' type='text' value='{$Think.get.telphone}'>
				订单数：<input id='order_num' name='order_num' type='text' value='{$Think.get.order_num}'>

				地址：
					<select name="flag" id="flag">
			         <option value="1" >选择</option>
			         <option value="2" >排除</option>
			        </select>
      				<input type="text" id="province" name="province" value="{$Think.get.province}"><br><br/>
				注册时间: 
					<label for="from">From</label>
						<input type="text" id="from" name="from" value="{$Think.get.from}" size="10">
					<label for="to">to</label>
						<input type="text" id="to" name="to" value="{$Think.get.to}"  size="10"/>

					&nbsp;&nbsp;&nbsp;&nbsp;
				注册来源:
					<select name="resour" onchange="change(this.value)">
						<option value="">全部</option>
						<volist name="plist" id="list">
							<option value="{$list.code}">{$list.name}</option>
						</volist>
					</select>
					&nbsp;&nbsp;
				附加参数：
					<select name="param" id="param">
						<option value="">全部</option>
					</select>
					&nbsp;&nbsp;&nbsp;&nbsp;
				终端类型:
					<select name="is_mobile">
						<option value="" selected>全部</option>
						<option value="0">网站</option>
						<option value="1">手机</option>
					</select>
					<br/><br>
				      			达人级别:
      				<select name="stickies">
						<option  selected>全部</option>
						<option value="1">普通</option>
						<option value="2">达人</option>
					</select>
					&nbsp;&nbsp;&nbsp;&nbsp;
				用户属性:
					<select name="userattr">
						<option value="" selected>全部</option>
						<option value="sina">sina</option>
						<option value="sohu">sohu</option>
					</select>
				<br/><br/>			
				用户类型:
					<input type="radio"  name='usertype' value='100'>内部用户&nbsp;
					<input type='radio' name='usertype' value='10'>真实用户
				&nbsp;&nbsp;&nbsp;&nbsp;
				是否完善地址:
					<input type="radio"  name='perfect' value='100'>是&nbsp;
					<input type='radio' name='perfect' value='10'>否
				&nbsp;&nbsp;&nbsp;&nbsp;
				邮件是否激活
					<input type="radio"  name='emailstatus' value='2'>是&nbsp;
					<input type='radio' name='emailstatus' value='1'>否
					&nbsp;&nbsp;&nbsp;&nbsp;
				手机是否验证
					<input type="radio"  name='telchk' value='1'>是&nbsp;
					<input type='radio' name='telchk' value='0'>否				
				<br/><br/>
					
					<input type="button" name="exportAllWhere" value="导出满足条件数据">
					<input type="button" name="resetpage" value="重置">
					<input type='submit' name='search' value=" 查 询 " >
					{/*
					<a href="javascript:void()"  onclick='traggle_task()'>创建推广任务</a>
					<div id='createtask'  style="display:none">
						<div style="float:left;width:50%">
						邮件模板：<select name="mailmoban">
						                <option value="0">---------</option>
						               <foreach item="value"  name="mailmoban">
						                <option value="{$value.id}">{$value['title']}</option>
						               </foreach> 
						        </select><br>
						条件描述：<textarea name="remark[]"  rows="2"  cols="40"></textarea><br>
						<input type="submit"  name="sendmail" value="创建推广邮件任务"  onclick="if(confirm('确认要加入邮件发送列表吗?')) return true;">
						</div>
						<div style="float:left;width:50%">
						短信模板：
							<select name="messmoban">
							               <option value="0">---------</option>
							               <foreach item="value"  name="messmoban">
							                <option value="{$value.id}">{$value['title']}</option>
							               </foreach> 
							 </select><br>
						条件描述：
							<textarea name="remark[]"  rows="2"  cols="40"></textarea><br>
							<input type="submit"  name="sendmess" value="创建推广短信任务" onclick="if(confirm('确认要加入到短信发送列表吗?')) return true;">
							</div>
							*/}
					</div>
					</form>
			</fieldset>
	</div>
</div>
<p align="right">			
   <if condition="$_SESSION['account'] eq 'admin'">		
	  <input type='button'  name='createUser'  id="createUser"  value='创建内部帐号'>
   </if>
	<input type="button" name="activateEmail" value="导出激活邮件地址">
	<input type="button" name="exportusertel" value="导出所有用户手机号">	
</p>
<table width="100%" border="0" align="center" cellpadding="0" cellspacing="0">
  <tr>
    <td height="30"><table width="100%" border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td width="15" height="30"><img src="__PUBLIC__/images/tab_03.gif" width="15" height="30" /></td>
        <td width="281" background="__PUBLIC__/images/tab_05.gif"><img src="__PUBLIC__/images/311.gif" width="16" height="16" /> <span class="STYLE4">用户列表</span></td>
        <td width="1101" background="__PUBLIC__/images/tab_05.gif" align="right">
        {$page}
        </td>
        <td width="14"><img src="__PUBLIC__/images/tab_07.gif" width="14" height="30" /></td>
      </tr>
    </table></td>
  </tr>
  <tr>
    <td><table width="100%" border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td width="9" background="__PUBLIC__/images/tab_12.gif">&nbsp;</td>
        <td bgcolor="#f3ffe3">
        <form name="orderlist" id="orderlist" >
         <table width="99%" border="0" align="center" cellpadding="0" cellspacing="1" bgcolor="#c0de98">
          <tr background="__PUBLIC__/images/tab_14.gif" align="center" height="26" id="awarp">
            <td width="1%"> 全选  	</td>
            <td width="3%"> 用户ID	</td>
            <td width="10%">邮箱	</td>
            <td width="5%"> 昵称	</td>
            <td width="5%"> 联系人	</td>
            <td width="8%"> 手机	</td>
            <td width="5%"> 邀请人	</td>
            <td width="5%"> 邀请数	</td>
            <td width="18%">地址信息 </td>
            <td width="7%"> 手机验证 </td>            
            <td width="3%"> 邮件激活 </td>            
            <td width="3%"> 订单数	</td>  
            <td width="3%">关注数	</td>
            <td width="3%"> 粉丝数	</td>
            <td width="3%"> 积分	</td>          
            <td width="3%"> 经验值	</td> 
			<td width="3%"> 分享数	</td>
            <td width="4%"> 达人级别 </td>
            <td width="4%"> 萝莉档案</td>
            <td width="8%"> 注册时间</td>
          </tr>
          <volist name="userlist" id="userlist" empty="暂时没有匹配的数据" key="k">
          <tr height="26" align="center" bgcolor="#FFFFFF">
            <td>
            	<input type="checkbox" value="{$userlist.userid}"  id="listcheckbox" name="listcheckbox[]" >
            </td>
            <td>
            	<a href="/space/{$userlist[userid]}" target="_blank">{$userlist[userid]}</a><br/><b>
            	{$userlist.usertype}</b>
            </td>
            <td>{$userlist[usermail]}</td>
            <td>
            	{$userlist.nickname}
            </td>
            <td>
            	{$userlist.personalInfo.linkman|default="***"}
            </td>
            <td>
            	{$userlist.personalInfo.telphone|default="***"}
            </td>
			<td>
				<a href="{:U('User/userlist',array('userid'=>$userlist['invite_uid']))}">{$userlist.invite_uid}</a>
			</td>
			<td>
				<a href="{:U('User/userlist',array('invite'=>$userlist['userid']))}">{$userlist.invitenum}</a>
			</td>
            <td>
            	{$userlist.personalInfo.province|default="***"}<br/>
            	{$userlist.personalInfo.address|default="***"}
            	<if condition="$userlist['personalInfo']['province'] neq '' AND $userlist['personalInfo']['address'] neq ''">
            		<a href="#" onclick="seeaddress('{$userlist.userid}')" style="color:red">查看</a>
            	</if>
            </td>
			<td>
				<eq name="userlist.tel_status" value="1">
					<img src='__PUBLIC__/images/status_1.gif' height='15' width='15'>
					{$userlist.telphone}
				<else/>
					<img src='__PUBLIC__/images/status_0.gif' height='15' width='15'>
				</eq>
			</td>
            <td>
            	<span onclick="changeEmailStatus('{$userlist['userid']}','{$k}')" id='email_{$k}'>
					<if condition="$userlist['state'] eq 2">
						<img src='__PUBLIC__/images/status_1.gif' height='15' width='15'  id="status" style="cursor: pointer">
					<else />
						<img src='__PUBLIC__/images/010.gif' height='15' width='15'  id="status" style="cursor: pointer">
					</if>
				</span>
				<input type="hidden" value="{$userlist['state']}"  id='email_s_{$k}'>
			</td>
						
            <td>
            	<if  condition="$userlist[order_num] neq '0'">
            		<a href="{:u('BoxSend/orderList',array('userid'=>$userlist[userid]))}">
            			{$userlist[order_num]}
            		</a>
            	<else/>
            		{$userlist[order_num]}
            	</if>
            </td>
            <td>
           		<a href="{:U('User/fansList',array('userid'=>$userlist[userid],'type'=>2))}">{$userlist.follow_num}</a>
            </td>
            <td>
            	<a href="{:U('User/fansList',array('userid'=>$userlist[userid],'type'=>1))}">{$userlist[fans_num]}</a>
            </td>
            <td>
            	<a href="{:U('UserCredit/creditStat',array('userid'=>$userlist[userid],'credit_type'=>'1'))}">{$userlist[score]}</a>
            </td>

            <td>
            	<a href="{:U('UserCredit/creditStat',array('userid'=>$userlist[userid],'credit_type'=>'2'))}">{$userlist[experience]}</a>
            </td>
			<td>
				<a href="{:U('UserShare/index',array('search'=>1,'userid'=>$userlist['userid']))}">{$userlist[blog_num]}</a>
			</td>
			<td> 
				<input type="hidden" id="status_{$k}" value="{$userlist[if_super]}">  
				<a href="#" id="key_{$k}" onclick="stickies('{$userlist.userid}','{$k}')">
				<if condition="$userlist[if_super] eq 0">普通<else />达人</if></a>
			</td>
			<td><a href="javascript:void(0)" onclick="see_vote('{$userlist.userid}')">查看</td>
            <td>
            	{$userlist[addtime]}
            </td>
          </tr>
		</volist>
        </table>
        </form>
		</td>
        <td width="9" background="__PUBLIC__/images/tab_16.gif">&nbsp;</td>
      </tr>
    </table></td>
  </tr>
  <tr>
    <td height="29" colspan="18" style="background:url(__PUBLIC__/images/tab_21.gif)" >
    	<div style="float:left;padding-left:20px;">{$page}</div>
		<div style="float:right">
		    	全选<input type="checkbox" value="全选" id="allSelect" name="allSelect">
                <input type="button"  id="Batch_addfans_but"  value="批量添加粉丝" style="padding-right:10px">
    	</div>
	</td>
  </tr>
</table>
<div id="userinfo_div" style="display: none">
	<form action="__URL__/addFans" method="post" name="add_fans_form"  id="add_fans_form"  onsubmit="return formcheck()">
		 <input type="hidden"  name="type"  value="1" id="type">
		<input type="hidden"  name="userid_list" value="" id="userid_list">
		粉丝数量：<input name="add_fansnum" type="text" value="0" id="add_fansnum"><br>
		<input type="submit"  id="addfans_submit" value="添加粉丝">
	</form>
</div>
<script>
	     function  formcheck(){
	    	 if($("#add_fansnum").val() <=0){
	    		 $("#add_fansnum").focus();
	    		 return false;
	    	 }
	    	 var api=$.dialog.tips('正在处理，请稍候...',600);
	    	 $.ajax({
	    		 type:"post",
	    		 url:"__URL__/addFans",
	    		 data:$("#add_fans_form").serialize(),
	    		 dataType:"json",
	    		 success:function(data){
	    			 api.close();
	    			 $.dialog.tips(data.info);
	    			 setTimeout("api_addfans.close();",3000);
	    		 }
	    	 })
	    	 return false;
	     }
	</script>
<script type="text/javascript">
if("{$Think.get.usertype}"){
	$(":radio[name='usertype'][value="+"{$Think.get.usertype}"+"]").attr("checked",true);
}

if("{$Think.get.flag}"){
	$("select[name='flag']").val("{$Think.get.flag}");
}

if("{$Think.get.userattr}"){
	$("select[name='userattr']").val("{$Think.get.userattr}");
}

$("select[name='is_mobile']").val('{$Think.request.is_mobile}');

$("#allSelect").click(function(){
	var obj =$("input[id='listcheckbox']:not(:disabled)");
	if($(this).is(':checked')){
		obj.each(function(){
			$(this).attr('checked',true);
		});
	}else{
		obj.each(function(){
			$(this).attr('checked',false);
		});
	}
});
$("input[id='listcheckbox']:not(:disabled)").click(function(){
	var obj = $("input[id='listcheckbox']:not(:disabled):not(:checked)");
	if(obj.length){
		$("#allSelect").attr('checked',false);
	}else{
		$("#allSelect").attr('checked',true);
	}
});
function stickies(userid,key){
	var tip1="是否确认要将用户升级为达人？";
	var tip2="是否确认要将达人用户变成普通用户？";
	var value=$("#status_"+key).val();

	if(value=='0'){
		if(confirm(tip1)){
			sendsti(userid,key);
		}

	}else if(value=='1'){
		if(confirm(tip2)){
			sendsti(userid,key);
		}
	}
}

function traggle_task(){
	var dis=$("#createtask").css("display");
	if(dis=='none'){
		$("#createtask").css("display","block");
	}else{
		$("#createtask").css("display","none");
	}
}

function sendsti(userid,key){
	$.ajax({
		url:"{:u('User/stickies')}",
		type:"post",
		dataType:"json",
		data:"userid="+userid+"&stickies=1"+"&m="+Math.random(),
		success: function(chkresult){
			if(parseInt(chkresult.status)==1){
				if(chkresult.data==1){
					$("#key_"+key).text('普通');
				}else{
					$("#key_"+key).text('达人');
				}
				$("#status_"+key).val(data);
			}
		}
	})
}

var api_addfans;
$("#Batch_addfans_but").click(function() {
	var list = seria();
	if (!list) {
		alert("请选择用户");
		return false;
	}
	$("#userid_list").val(list);
	$("#addfans_userinfo").css("display", "none");
	api_addfans=$.dialog({
		title : "批量添加粉丝",
		content : $("#userinfo_div").html()
	});

})

function changeEmailStatus(userid,key){
	var v=$("#email_s_"+key);
	if(userid != undefined){
		$.ajax({
			url:"{:U('User/changeUserEmailStatus')}",
			type:"post",
			dataType:"json",
			data:"userid="+userid+'&status='+v.val(),
			success: function(chkresult){
				if(parseInt(chkresult.status)==1){
					if(v.val()==0){
						$("#email_"+key+">img").attr('src','__PUBLIC__/images/status_1.gif');
						v.val('2');
					}else{
						$("#email_"+key+">img").attr('src','__PUBLIC__/images/010.gif');
						v.val('0');
					}
				}else{
					alert(chkresult.info);
				}
			}
		})
	}
}

var api;
api= $("#createUser").dialog({
			title:"上传昵称文件",
			content:'<iframe id="hidden_frame"  style="display:none"></iframe><form action="__ACTION__/do/createuser" method="POST" enctype="multipart/form-data"  target="hidden_frame"> 文件必须是<span style="color:red">txt格式,UTF-8编码<br><br></span><input type="file"  name="nickname_txt"><br><input type="submit"  name="提交"></form></div>',
 });
	
$("#addfans_submit").click(function(){
 if($("#add_fansnum").val() <=0){
	 $("#add_fansnum").focus();
	 return false;
 }
 var api=$.dialog.tips('正在处理，请稍候...',600);
 $.ajax({
	 type:"post",
	 url:"__URL__/addFans",
	 data:$("#add_fans_form").serialize(),
	 dataType:"json",
	 success:function(data){
		 api.close();
		 $.dialog.tips(data.info);
		 setTimeout("api_addfans.close();",1000);
	 }
 })
 return false;
})    
   
   
function create_user_handle($num){
		alert("成功创建了 "+$num+" 个帐号");
		location.href = location.href;
	}
			
$(":button[name='activateEmail']").bind('click',function(){
	location.href="__ACTION__/exportemail/activateEmail";
})

$(":button[name='exportusertel']").click(function(){
	location.href="__URL__/exportUserTelphone";
})

$(":button[name='exportAllWhere']").click(function(){
	$("#myform").append("<input type='hidden'  name='ac' value='exportAllWhere'>").submit();
	$(":hidden[name='ac']").remove();
})

	jQuery(function($){
		$.datepicker.regional['zh-CN'] = {
			closeText: '关闭',
			prevText: '&#x3c;上月',
			nextText: '下月&#x3e;',
			currentText: '今天',
			monthNames: ['一月','二月','三月','四月','五月','六月',
			'七月','八月','九月','十月','十一月','十二月'],
			monthNamesShort: ['一','二','三','四','五','六',
			'七','八','九','十','十一','十二'],
			dayNames: ['星期日','星期一','星期二','星期三','星期四','星期五','星期六'],
			dayNamesShort: ['周日','周一','周二','周三','周四','周五','周六'],
			dayNamesMin: ['日','一','二','三','四','五','六'],
			weekHeader: '周',
			dateFormat: 'yy-mm-dd',
			firstDay: 1,
			isRTL: false,
			showMonthAfterYear: true,
			yearSuffix: '年'};
			$.datepicker.setDefaults($.datepicker.regional['zh-CN']);
	});
	$(function() {
		var stickies="{$Think.request.stickies}";
		if(stickies==1||stickies==2){
			$("select[name='stickies']").val("{$Think.request.stickies}");
		}

		if("{$Think.get.usertype}"){
			$("select[name='usertype']").val("{$Think.get.usertype}");
		}

		var pef="{$Think.get.perfect}";
		if(pef == 10 || pef == 100)
		{
			$("input[name=perfect][value="+pef+"]").attr("checked",true);
		}
		
		var emailstatus="{$Think.get.emailstatus}";
		if(emailstatus){
			if(emailstatus == 2){
				$("input[name=emailstatus][value='2']").attr("checked",true);
			}else{
				$("input[name=emailstatus][value='1']").attr("checked",true);
			}
		}	
		
		if("{$Think.get.telchk}" != ''){
			$("input[name=telchk][value='"+"{$Think.get.telchk}"+"']").attr("checked",true);
		}
		
		$( "#from" ).datepicker({
			defaultDate: "-1w",
			changeMonth: true,
			numberOfMonths: 1,
			onSelect: function( selectedDate ) {
				$( "#to" ).datepicker( "option", "minDate", selectedDate );
			}
		});
		$( "#to" ).datepicker({
			defaultDate: "+1w",
			changeMonth: true,
			numberOfMonths: 1,
			onSelect: function( selectedDate ) {
				$( "#from" ).datepicker( "option", "maxDate", selectedDate );
			}
		});
	});

function addproduct(orderid){
	$.dialog({title:'产品添加',content: 'url:__URL__/addproduct/orderid/'+orderid,width:'700px',height:'400px',
	close: function(){
		this.reload();
	},
	ok: function(){
		this.reload();
	}
	});
}

if("{$Think.get.resour}"){
	$("select[name='resour']").val("{$Think.get.resour}");
}

change("{$Think.get.resour}", "{$Think.get.param}");

function change(value,param){

	if(value != ''){
		var type="userlist";
		$.ajax({
			url:"{:U('EdmMarketing/returnPromotionOrderNum')}",
			type:"post",
			dataType:"json",
			data:'changeCode='+value+"&type="+type,
			success: function(chkresult){
				if(parseInt(chkresult.status)==1){
					var data = chkresult.data;
					$("select[name='param'] option:gt(0)").remove();
					if(data != null){
						for(var i in data){
							$("select[name='param']").append("<option value='"+data[i].frominfo+"'>"+data[i].frominfo+"</option>");
						}
					}

					if(param != '' || param != 'undefined'){
						$("select[name='param']").val(param);
					}
				}
			}
		})
	}else{
		$("select[name='param'] option:gt(0)").remove();
	}
}

function editSendInfo(orderid){
	$.dialog({title:'订单发送信息管理',content: 'url:__URL__/editOrderSendInfo/orderid/'+orderid,width:'500px',height:'400px',
	close: function(){
		this.reload();
	},
	ok: function(){
		this.reload();
	}
	});
}

function seeaddress(userid){
	$.ajax({
		url:"{:u('BoxSend/getaddress')}",
		type:"post",
		dataType:"json",
		data:"userid="+userid+'&n='+Math.random(),
		success: function(chkresult){
			if(parseInt(chkresult.status)==1){
				var data=chkresult.data;
				var str='';
				for(var i in data){
					if(data[i]['if_active']==1) {
						str+="<b>[*默认地址*]</b>";
					}

					str+=data[i]['linkman']+data[i]['telphone']+data[i]['province']+data[i]['city']+data[i]['district']+data[i]['address']+data[i]['postcode']+"<br/><br/>";
				}
				$.dialog({
					title:'查看地址',
					content: str,
					cancel: true
				});
			}
		}
	})
}

function seria(){
	var obj =$("input[id='listcheckbox']:not(:disabled)");
	var ids='';
	obj.each(function(){
		if($(this).attr('checked'))
		{
			ids+=$(this).val()+",";
		}
	});
	return ids;
}

pregpattern({
"userid":"用户ID",
"order_num":"订单数",
"follow_num":"关注数",
"fans_num":"粉丝数",
"score":"积分",
"experience":"经验值",
"blog_num":"分享数"
},"__ACTION__");



//查看萝莉档案
function see_vote(userid){
	if(!userid){
		return false;
	}
	$.ajax({
		url:"{:u('User/get_user_vote')}",
		type:'post',
		dataType:"json",
		data:{userid:userid},
		success:function(ret){
			var data=ret.info;
			var str="";
			$.each(data,function(key,index){
				str+="<b>"+index.title+"</b>("+index.state+")<br />";
				if(index.result){
					str+="　　<span style='color:red;'>"+index.result+"</span><br /><br />";
				}else{
					str+="<br />";
				}
			})
			var vote_dialog=$.dialog({
				"title":"萝莉档案",
				"content":str
			})
		}
	})
}

</script>
<include file="Public:footer" />