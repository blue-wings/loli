<include file="Public:header" />
<style>
.crea{
	display:none;
}
.csd{
	padding:20px 150px;
}
.red{
	color:red;
}
input,select{
	border-color:#008080;
}
.ftr{
	width:20%;
	padding-right:20px;
}
.trheight{
	height:40px;
}
.clearbored{
	border:0;
}
.ti{
	width:80px;
	margin-left:200px;
}
.inwidth{
	width:50px;
	text-align:center;
}
tr{
	align:center;
}

input .addsize{
	width:50px;
	height:20px;
}
.tips{
	margin:0;
	padding:0;
	border:solid red 1px;
}
td.cals{
	color:#804040;
	font-size:14px;
}
.backg{
	background-color:#FFF;
	border:0;
}
</style>
<div class="list">
<form action="__ACTION__" method="POST" name='order' onsubmit="return checkform()">
<table width="100%" border="0" align="center" cellpadding="0" cellspacing="0">
  <tr>
    <td height="30"><table width="100%" border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td width="15" height="30"><img src="__PUBLIC__/images/tab_03.gif" width="15" height="30" /></td>
        <td width="1101" align="left" background="__PUBLIC__/images/tab_05.gif">
		  <img src="__PUBLIC__/images/311.gif" width="16" height="16" /><span style="color:red">{$boxname}</span>的选货单
		</td>
        <td width="281" background="__PUBLIC__/images/tab_05.gif"><table border="0" align="right" cellpadding="0" cellspacing="0">
        </table></td>
        <td width="14"><img src="__PUBLIC__/images/tab_07.gif" width="14" height="30" /></td>
      </tr>
    </table></td>
  </tr>
  <tr>
    <td><table width="100%" border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td width="9" background="__PUBLIC__/images/tab_12.gif">&nbsp;</td>
        <td bgcolor="#f3ffe3">
		
        <table width="99%" border="0" align="center" cellpadding="0" cellspacing="1" bgcolor="#c0de98" id='tab'>
          <tr background="__PUBLIC__/images/tab_14.gif" align="center" height="26">
			<td width="5%">	序号		</td>
			<td width="5%">	推荐	</td>
			<td width="5%">	显示	</td>
			<td width="5%">	排序值	</td>
			<td width="5%">显示量	</td>
			<td width="5%">	折扣率	</td>
            <td width="5%">	单品id	</td>
			<td width="3%">	X		</td>
            <td width="6%">	数量		</td>
            <td width="6%">	总数量	</td>
			<td width="5%">多选X</td>
			<td width="6%">	已售出数量</td>
          	<td width="30%">产品名称	</td>
          	<td width="10%">理论库存数</td>
          	<td width="5%">DEL</td>
          </tr>
			<tr align="center" class="first" height="18" bgcolor="#FFFFFF">
				<td>&nbsp;</td>
				<td>
					<input type="checkbox" name="newnewoptional">
				</td>
				<td>
					<input type="checkbox" name="doish">
				</td>	
				<td>
					<input type="text" name="sortnum"  value="0"  size="4">
				</td>	
				<td>
--
				</td>
				<td>
--	
				</td>
				<td>
					<input size="4" type="text" name="productid" value="">
				</td>
				<td>X</td>
				<td>
					<input size="4" type="text" name="amount" value="">
				</td>
				<td>
					<input size="4" type="text" name="sumtotal" value="">
				</td>
				<td>
					<input size="4" type="text" name="selectable" value="">
				</td>
				<td class="maxsale">0</td>
				<td class="pnamevalue"></td>
				<td class="estimated"></td>
				<td></td>
			</tr>
			<tr>
				<td colspan="16" align="center">
					<input type="button" name="chooseadd" value="加入">
				</td>
			</tr>
			<tr>
				<td colspan="16" class="backg">&nbsp;</td>
			</tr>
			  <if condition="$oplist['optional'] neq ''">
	          <volist name="oplist.optional" id="option" emtpy="这里一片空白" key="k">
		          <tr class="typenum">
		          <td class="cals">多选{$option['0'].maxquantitytype}</td>
		          <td colspan="10"><input type="text" name="typename" value="{$option['0'].title}" size="10"></td>
		          </tr>
				<volist name="option" id="op" key='n'>
						<tr align="center" class="num_{$op.maxquantitytype}" height="18" bgcolor="#FFFFFF">
							<td>{$n}</td>
							<td>
								<if condition="$op.iscommend eq 1">
									<input type="checkbox" checked name="recommend[]" value="">
								<else />
									<input type="checkbox" name="recommend[]" value="">
								</if>
							</td>
							<td><a href="javascript:void(0);" onclick="change_hidden({$op.id},{$op.ishidden});"><div>
								<if condition="$op.ishidden eq 1">
									<img id="hidden_{$op.id}" src='__PUBLIC__/images/status_0.gif' height='15' width='15'>
								<else />
									<img id="hidden_{$op.id}" src='__PUBLIC__/images/status_1.gif' height='15' width='15'>
								</if></div></a>

							</td>
							<td>
					            <input type="text" name="sortnum[]"  idvalue="{$op.id}"  value="{$op.sortnum|default=0}"  size="4">
				            </td>
							<td>
					            <input type="text" name="settotal{$op.id}"  id="settotal{$op.id}"  value="{$op.settotal|default=0}"  size="4" onchange="changeSettotal({$op.id})">
				            </td>
							<td>
					            <input type="text" name="discount{$op.id}"  id="discount{$op.id}"" value="{$op.discount|default=0}"  size="4" onchange="changeDiscount({$op.id})">
				            </td>
							<td>
								<input type="text" name="falseid[]" value="{$op.pid}" size="4" disabled>
								<input type="hidden" name="pid[]" value="{$op.pid}">
								<input type="hidden" name="id[]" value="{$op.id}">
							</td>
							<td>X</td>
							<td>
								<input type="text" name="quantity[]" size="4" value="{$op.pquantity}">
							</td>
							<td>
								<input type="text" name="total[]" size="4" value="{$op.ptotal}">
							</td>
							<td>
								<input type="hidden" name="max[]" size="4" value="{$op.maxquantitytype}">
								<input type="text" name="maxmax[]" size="4" value="{$op.maxquantitytype}" disabled>
							</td>
							<td class="maxsale">
								{$op.saletotal}
							</td>
							<td class="pnamevalue">{$op.pname}</td>
							<td class="estimated">{$op.estimated}</td>
							<td>
								<a href="#" class="delete" onclick="delindex(this);return false;">删除</a>
							</td>
						</tr>
					 </volist>   
			  </volist>
			  </if>	  
        </table></td>
        <td width="9" background="__PUBLIC__/images/tab_16.gif">&nbsp;</td>
      </tr>
    </table></td>
  </tr>
   <tr>
    <td><table width="100%" border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td width="9" background="__PUBLIC__/images/tab_12.gif">&nbsp;</td>
        <td bgcolor="#f3ffe3">
        <table width="99%" border="0" align="center" cellpadding="0" cellspacing="1" bgcolor="#c0de98" id='tab2'>
         <tr><td colspan="9">福利单品</td></tr>
          <tr background="__PUBLIC__/images/tab_14.gif" align="center" height="26">
			<td width="5%">		序号			</td>
            <td width="5%">		是否推荐		</td>
            <td width="5%">		是否隐藏		</td>
			<td width="5%">		产品id		</td>
			<td width="3%">		X			</td>
            <td width="6%">		数量			</td>
            <td width="6%">		总数量		</td>
			<td width="10%">	该类最多可选数量</td>
			<td width="6%">		已售出数量	</td>
          	<td width="30%">	产品名称		</td>
          	<td width="10%">	理论库存数	</td>
          	<td width="5%"></td>
          </tr>	     
		  <if condition="$oplist.welfare neq ''">
          <volist name="oplist.welfare" id="wel" emtpy="这里一片空白" key="i">
			<tr align="center" height="18" bgcolor="#FFFFFF">
				<td>{$i}</td>
				<td>
				不推荐
				</td>
				<td>
				显示
				</td>				
				<td>
					<input type="text" name="falseid[]" size="4" value="{$wel.pid}" disabled>
					<input type="hidden" name="pid[]" value="{$wel.pid}">
					<input type="hidden" name="id[]" value="{$wel.id}">
				</td>
				<td>X</td>
				<td>
					<input type="text" name="quantity[]" size="4" value="{$wel.pquantity}">
				</td>
				<td>
					<input type="text" name="total[]" size="4" value="{$wel.ptotal}">
				</td>
				<td>
					<input type="hidden" name="max[]"  value="{$wel.maxquantitytype}">
					<input type="text" value="0" disabled size="4">
				</td>
				<td class="maxsale">{$wel.saletotal}</td>
				<td class="pnamevalue">{$wel.pname}</td>
				<td class="estimated">{$wel.estimated}</td>
				<td>
					<a href="#" class="delete" onclick="delindex(this);return false;">删除</a>
				</td>
			</tr>
		  </volist>
		  </if>
        </table></td>
        <td width="9" background="__PUBLIC__/images/tab_16.gif">&nbsp;</td>
      </tr>
    </table></td>
  </tr>
  </table>
<p>
<input type='submit' name='sub' value='确定' style="width:80px;height:25px;">
</p>
</form>
</div>
<script type="text/javascript">
$(":text[name='typename']").live("blur",function(event){
	var  title =$(this).val();

	if(title){
		var optional =  $(this).parent().parent().find(".cals").text().replace(/[^0-9]/ig,""),
		boxid = $(":hidden[name='bid']").val();
		$.ajax({
			url:"__ACTION__",
			type:"post",
			dataType:"json",
			data:"boxid="+boxid+'&optional='+optional+'&title='+title+'&n='+Math.random(),
			success: function(chkresult){
				if(chkresult == null){
					alert('修改未成功!');
				}
			}
		})
	}
	event.stopPropagation();
});

//捕捉添加记录的点击事件
$(":button[name='chooseadd']").bind("click",function(){
	var productid =$(":text[name='productid']"),
	mount=$(":text[name='amount']"),
	total=$(":text[name='sumtotal']"),
	select=$(":text[name='selectable']"),
	sortnum=$("input[name='sortnum']"),
	pnamevalue=$("tr.first > td.pnamevalue"),
	estimated=$("tr.first > td.estimated"),
	status=0,stus=0,istrue=0,opa=0,min=0,str='';

	//返回错误的情况
	$(":input[name='pid[]']").each(function(){
		if($(this).val()==productid.val()){
			alert('不能填写重复的单品ID:  '+productid.val()+' ，请检查后再提交!');
			istrue=1;
			return false;
		}
	})

	if(istrue==1){
		return false;
	}
	if(pnamevalue.text()==''){
		alert(productid.val()+" 产品不存在,请检查再提交");
		return false;
	}

	if(parseInt(total.val()) > parseInt(estimated.text())){
		alert("产品ID为: "+productid.val()+" 的总数量超过了库存数,请检查再提交!");
		return false;
	}

	if($(":text[name='selectable']").val()!=0){
		stus=$(":text[name='selectable']").val();
	}

	if(parseFloat(select.val()) < 1){
		opa=$("#tab2 tbody>tr").length-1;
	}else{
		opa=parseInt($("tr.num_"+stus).length)+1;
	}

	str+='<tr align="center" class="num_'+select.val()+'" hwight="18" bgcolor="#FFFFFF"><td>'+opa+'</td><td>';

	if($(":checkbox[name='newnewoptional']").attr("checked") != undefined){
		str+='<input type="checkbox" name="recommend[]" value="" checked>';
	}else{
		str+='<input type="checkbox" name="recommend[]" value="">';
	}
	str+='</td><td>';
	if($(":checkbox[name='doish']").attr("checked") != undefined){
		str+='<input type="checkbox" name="ish[]" value="" checked>';
	}else{
		str+='<input type="checkbox" name="ish[]" value="">';
	}
	str+='</td><td></td><td></td><td></td><td><input type="text" size="4" name="pid[]" value="'+productid.val()+'"><input type="hidden" name="id[]" value="'+productid.val()+'"></td>';
	str+='<td>X</td>';
	str+='<td><input size="4" type="text" name="quantity[]" value="'+mount.val()+'"></td>';
	str+='<td><input size="4" type="text" name="total[]" value="'+total.val()+'"></td>';
	str+='<td><input size="4" type="text" name="max[]" value="'+stus+'"></td>';
	str+='<td class="maxsale">0</td>';
	str+='<td class="pnamevalue">'+pnamevalue.text()+'</td>';
	str+='<td class="estimated">'+estimated.text()+'</td>';
	str+='<td><a href="#" class="delete" onclick="delindex(this);return false;">删除</a></td></tr>';

	//非福利
	if(parseInt(select.val()) >0){
		$("td.cals").each(function(i){
			var val = $(this).text().replace(/[^0-9]/ig,"");
			if(val == select.val()){
				status =1;
			}
		})

		if(status==0){
			var place=minimization(select.val());

			if(place ==100){
				$("#tab").append('<tr><td class="cals">多选'+select.val()+'</td><td colspan="10"><input type="text" name="typename" value="" size="10"></td></tr>');
				$("#tab").append(str);
			}else{
				var sss='<tr><td class="cals">多选'+select.val()+'</td><td colspan="10"><input type="text" name="typename" value="" size="10"></td></tr><tr class="nnum_'+place+'"></tr>';

				$("tr.num_"+place+":first").prev().before(sss);
				$("tr.nnum_"+place).after(str);
				$("tr.nnum_"+place).remove();
			}
		}else{
			$("tr.num_"+select.val()+":last").after(str);
		}
	}else{
		//福利
		$("#tab2").append(str);
	}

	productid.val("");
	mount.val("");
	total.val("");
	select.val("");
	pnamevalue.text("");
	estimated.text("");
	$(":checkbox[name='newnewoptional']").attr('checked',false);
	$(":checkbox[name='doish']").attr('checked',false);
})

function delindex(obj){
	if(confirm('确定删除么?')){
		var domm = $(obj).parent().parent();
		var value =domm.find(":hidden[name='id[]']").val();
		alert(value);return false;
		$.ajax({
			url:"{:U('Box/delboxProducts')}",
			type:"post",
			dataType:"json",
			data:"opid="+value+'&n='+Math.random(),
			success: function(chkresult){
				if(chkresult != null){
					if(chkresult.info == 'only'){
						domm.prev().remove();
					}
					domm.remove();
				}else{
					alert("删除不成功,请检查!");
				}
			}
		})
	}
}

function minimization(num){
	var max=100;
	$("td.cals").each(function(i){
		var value = $(this).text().replace(/[^0-9]/ig,"");

		if(parseInt(value) > num){
			if(parseInt(value) <max){
				max = value;
			}
		}
	})
	return max;
}

$(function(){
	$("td.maxsale").each(function(){
		if(Number($(this).text()) > 0){
			$(this).parent().find(".delete").remove();
		}
	})

	var boxid="{$_GET['boxid']}";
	$("form[name=order]").prepend("<input type='hidden' name='bid' value='"+boxid+"'>");

	$(":text[name='pid[]'],:text[name='productid']").live('keyup',function(event){
		var th=$(this);
		$.ajax({
			url:"{:U('Box/getProductsData')}",
			type:"post",
			dataType:"json",
			data:"pid="+th.val()+'&n='+Math.random(),
			success: function(chkresult){
				if(chkresult != null){
					th.parent().siblings(".pnamevalue").text(chkresult.data);
					th.parent().siblings(".estimated").text(chkresult.info);
				}else{
					th.parent().siblings(".pnamevalue").empty();
				}
			}
		})
		event.stopPropagation();
	})
})

$(function(){
  $("input[name='sortnum[]']").change(function(){
	  var sortnum = $(this).val(),
	  id = $(this).attr("idvalue");
	  if(!id || !sortnum){
	     alert("缺少参数");
		 return false;
	  }
      $.ajax({
	     url:"__ACTION__",
		 data:{id:id,ac:"sort",sortnum:sortnum},
		 type:"post",
		 dataType:"json",
		 success:function(data){
		     if(data.status==1){
			    alert("排序值设置完成");
			 }else{
			    alert(data.info);
			 }
		 }
	  })
  })  
})




//检查表单
//产品ID不能填写重复的,单品ID不能小于0
//数量不能为空
//总数量不能为空
//可选数量不能为空
//产品不存在不能提交
//总数量超过库存数不能提交
function checkform(){
	var parray=Array();
	var status=0;
	$(":input[name='pid[]']").each(function(){

		var ish = $(this).parent().prev().find(":checkbox[name='ish[]']");

		if(ish.attr("checked") != undefined){
			ish.val($(this).val());
		}

		var comm=$(this).parent().prev().prev().find(":checkbox[name='recommend[]']");

		if(comm.attr("checked") != undefined){
			comm.val($(this).val());
		}

		var pid=parseInt($(this).val());
		if(pid>0){
			if(jQuery.inArray(pid,parray)==-1){
				status+=1;
				parray.push(pid);
			}else{
				status=0;
				alert('不能填写重复的单品ID:  '+pid+'  ，请检查后再提交!');
				return false;
			}
		}else{
			alert('单品ID不能小于0，请检查后再提交!');
			status=0;
			return false;
		}

		var quantity=$(this).parent().next().next();//
		if(Number(quantity.find("input[name='quantity[]']").val())==''){
			alert('数量不能为空!');
			status=0;
			return false;
		}

		var total=quantity.next();
		var totalv=total.find("input[name='total[]']").val();
		if(totalv==''){
			alert('总数量不能为空!');
			status=0;
			return false;
		}


		var max=total.next();
		var maxv=max.find("input[name='max[]']").val();
		if(maxv==''){
			alert('可选数量不能为空');
			status=0;
			return false;
		}

		var pname=max.next().next();
		if(pname.text()==''){
			alert(pid+" 产品不存在,请检查再提交");
			status=0;
			return false;
		}

		var sale=max.next();
		var salev=parseInt(sale.text());
		if(salev < 1){
			var estimated=pname.next();
			if(totalv > parseInt(estimated.text())){
				alert("产品ID为: "+pid+" 的总数量超过了库存数,请检查再提交!");
				status=0;
				return false;
			}
		}
	})
	if(status==0){
		return false;
	}
}

//修改自选单隐藏状态，val可以不传
function change_hidden(id,val){
		$.ajax({
			url:"{:U('Box/ajax_change_hidden')}",
			type:"post",
			dataType:"json",
			data:"id="+id+'&ishidden='+val,
			success: function(chkresult){
				if(parseInt(chkresult.status)==1){
					if(chkresult.info==0){
						$("#hidden_"+id).attr('src','__PUBLIC__/images/status_1.gif');
					}else{
						$("#hidden_"+id).attr('src','__PUBLIC__/images/status_0.gif');
					}
				}else{
					alert(chkresult.info);
				}
			}
		})
}

//修改展示量
function changeSettotal(id){
	settoal_val=$("#settotal"+id).val();
	$.ajax({
		url:"{:U('Box/ajax_change_settotal')}",
		type:"post",
		dataType:"json",
		data:"id="+id+'&settotal='+settoal_val,
		success: function(chkresult){
			if(parseInt(chkresult.status)==1){
				alert(chkresult.info);
			}else{
				alert(chkresult.info);
			}
		}
	})
}
//修改折扣率
function changeDiscount(id){
	discount_val=$("#discount"+id).val();
	$.ajax({
		url:"{:U('Box/ajax_change_discount')}",
		type:"post",
		dataType:"json",
		data:"id="+id+'&discount='+discount_val,
		success: function(chkresult){
			if(parseInt(chkresult.status)==1){
				alert(chkresult.info);
			}else{
				alert(chkresult.info);
			}
		}
	})
}

</script>
<include file="Public:footer" />