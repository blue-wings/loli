<include file="Public:header" />
<div class="panel">
<div align="left">			

<fieldset class="fieldset">
<legend>{$Think.request.listname}查询条件</legend>
<form name="myform" id="myform" action="__ACTION__" method="get">
订单号查询：<input name='orderid' type='text' value='{$Think.get.orderid}'>  
用户ID查询：<input name='userid' type='text' value='{$Think.get.userid}'>

盒子列表<select name="boxid" id="boxid">
			<option value=''>全部</option>
				<volist name='listbox' id='list' key='k'>
					<option value='{$list.bid}'>{$list.boxname}</option>
				</volist>
		</select>
&nbsp;子订单时间<select name="child_id" id="child_id">
			<option value=''>全部</option>
				<volist name='timelist' id='list' key='k'>
					<option value='{$list}'>{$list}</option>
				</volist>
		</select>
<br />		<br />		
订单状态：<select name='ifpost' id='ifpost'>
<option <eq name="Think.request.ifpost" value=""> selected="selected" </eq> value="">请选择</option>
<option <eq name="Think.request.ifpost" value="post"> selected="selected" </eq> value="post">已经配货发送</option>
<option <eq name="Think.request.ifpost" value="nopost"> selected="selected" </eq> value="nopost">未配货发送</option>
</select>&nbsp;&nbsp;&nbsp;		
		
		
<script>

var child_id="{$Think.get.child_id}";
if(child_id){
	$("select[name='child_id']").val(child_id);
}

</script>		
		
		
<br><br>
<input type="button" name="resetpage" value="重置">
<input type="submit" name="search" vlaue="提交" /><br><br>
<!--input type="submit" value="导出查询结果" name="outputexcel" /-->
</form><br/>

</fieldset>
		</div>
	</div>
<table width="100%" border="0" align="center" cellpadding="0" cellspacing="0">
  <tr>
    <td height="30"><table width="100%" border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td width="15" height="30"><img src="__PUBLIC__/images/tab_03.gif" width="15" height="30" /></td>
        <td width="281" background="__PUBLIC__/images/tab_05.gif"><img src="__PUBLIC__/images/311.gif" width="16" height="16" /> <span class="STYLE4">订单配货管理</span></td>
        <td width="1101" background="__PUBLIC__/images/tab_05.gif" align="right">{$page}</td>
        <td width="14"><img src="/siteadmin/Public/images/tab_07.gif" width="14" height="30" /></td>
      </tr>
    </table></td>
  </tr>
  <tr>
    <td><table width="100%" border="0" cellspacing="0" cellpadding="0" id="showdata">
      <tr>
        <td width="9" background="__PUBLIC__/images/tab_12.gif">&nbsp;</td>
        <td bgcolor="#f3ffe3">
        <form name="orderlist" id="orderlist" >
        <input type="hidden"  name="listname"  value="{$Think.request.listname}">
        <table width="99%" border="0" align="center" cellpadding="0" cellspacing="1" bgcolor="#c0de98">
          <tr background="__PUBLIC__/images/tab_14.gif">
            <td width="3%" height="26" align="center">全选</div></td>
            <td width="10%" height="26" align="center">订单号</td>
            <td width="5%" height="26" align="center">子订单号</td>
            <td width="10%" height="18" align="center">用户名</td>
            <td width="8%" height="18" align="center">查看产品</td>
            <td width="8%" height="18" align="center">快递信息</td>
          </tr>
          <volist name="userlist" id="usersendlist" empty="暂时没有匹配的数据">
          <tr height="60px" align="center">
            <td bgcolor="#FFFFFF" height="18"><input type="checkbox" value="{$usersendlist[orderid]}-{$usersendlist[child_id]}"  id="listcheckbox" name="listcheckbox[]" ></td>
            <td bgcolor="#FFFFFF" height="18">
            <font color="red">{$usersendlist[boxname]}</font><br>
            {$usersendlist.orderid}
            <notempty name="usersendlist.addproject"><br><br>加价购方案:{$usersendlist.addproject}</notempty>
            </td>
            <td bgcolor="#FFFFFF" height="18">{$usersendlist.child_id}</td>
            <td bgcolor="#FFFFFF" height="18">
			<a target="_blank" href="{:U('User/userList',array('email'=>$usersendlist[address][usermail]))}" style="color:blue;">用户名:{$usersendlist[address][usermail]}，ID：{$usersendlist[address][userid]}</a>
			<br/>联系人：{$usersendlist[address][linkman]}  联系电话：{$usersendlist[address][telphone]}<br/>
			{$usersendlist[address][province]}{$usersendlist[address][city]}{$usersendlist[address][district]}{$usersendlist[address][address]}&nbsp;({$usersendlist[address][postcode]})<br/>
			<a href="#" onclick="editAddress('{$usersendlist[orderid]}','{$usersendlist[userid]}','{$usersendlist[address_id]}')"><font color=red>修改地址</font></a>
			<if condition="$usersendlist[sendword] neq ''"><br><div style="background:#eee000">礼品寄语：{$usersendlist[sendword]}</div></if>
			</td>
			
            <td bgcolor="#FFFFFF" height="18">
            <div align="center">
				<if condition="($usersendlist.proxysender neq '') and ($usersendlist.proxyorderid neq '') and ($usersendlist.senddate neq '')">
				<gt name="usersendlist.productnum" value="0">
			    	<a href="javascript:void(0);" onclick="chakanproduct('{$usersendlist[orderid]}-{$usersendlist[child_id]}');">查看商品<br>(数量{$usersendlist[productnum]})<br></a>
			    </gt>
			    	<if condition="($usersendlist.proxysender eq '') OR ($usersendlist.proxyorderid eq '') OR ($usersendlist.senddate eq '')">
			    	<eq name="Think.session.account" value="admin">
			    		<a href="javascript:void(0);" onclick="addproduct('{$usersendlist[orderid]}-{$usersendlist[child_id]}');">
			    			修改商品
			    		</a>
			    	</eq>
			    </if>
				<else/>
			    	<a href="javascript:void(0);" onclick="addproduct('{$usersendlist[orderid]}-{$usersendlist[child_id]}');">
			        <if condition="$usersendlist.productnum gt 0">
					    <font color="red">修改/查看</font><br>
					    商品数：{$usersendlist[productnum]}<br>
				    	金额：{$usersendlist[productprice]}
				    <else/>
					   添加产品
			    	</if>			
				    </a>	
				</if>	
			</div>
			</td>
            <td bgcolor="#FFFFFF" height="18"><div align="center">
			<if condition="$usersendlist.productnum gt 0">
				<a href="javascript:void(0);" onclick="editSendInfo('{$usersendlist[orderid]}-{$usersendlist[child_id]}');">
					{$usersendlist.address.proxysender}{$usersendlist.address.proxyorderid|default="<font color=red>编辑快递信息</a>"}
				</a>
			<else/>
					<if condition="$usersendlist.proxysender neq '' OR $usersendlist.if_can eq 1">
						<a href="javascript:void(0);" onclick="editSendInfo('{$usersendlist[orderid]}-{$usersendlist[child_id]}');">
						{$usersendlist.address.proxysender}{$usersendlist.address.proxyorderid|default="<font color=red>编辑快递信息</a>"}
						</a>
					<else/>
						先添加产品
					</if>
			</if>
			</div>
            <if condition="($usersendlist.proxysender neq '') and ($usersendlist.proxyorderid neq '') and ($usersendlist.senddate neq '')">
            <a href="javascript:void(0)" onclick="send_proxy_info('{$usersendlist[orderid]}-{$usersendlist[child_id]}')"><font color=red>查看物流进度</font></a>
            </if>
			</td>
          </tr>
		</volist>

        </table>
		</form>

	<script>

	function addproduct(orderid){
		$.dialog({title:'产品添加',content:'url:/admin/BoxSend/addproduct/orderid/'+orderid,
		init: function () {
			this.max();
		},

		close: function(){
			this.reload();
		},
		ok: function(){
			this.reload();
		}
		});
	}

	//查看每个用户添加的产品
	function chakanproduct(	orderid){
		$.dialog({title:"查看产品",content:"url:/admin/BoxSend/productlist/orderid/"+orderid,width:"500px",height:"300px"});
	}

	//查看用户发货的进度
	function send_proxy_info(orderid)
	{
		$.dialog({title:"发货情况明细",content:"url:/admin/BoxSend/send_proxy_info/orderid/"+orderid+".html",width:"600px",height:"500px"});
	}

	function addproductMuch(){
		var obj=$("input[id='listcheckbox']:not(:disabled):checked");
		if(obj.length==1){
			addproduct(obj.val());
			return false;
		}
		var str="";
		obj.each(function(i,n){
			var temp =$(this).val();
			if(temp!=""){
				str+="'"+temp+"'";
			}
			if(obj.length!=(i+1)){
				str+=',';
			}
		});
		if(str==""){
			alert('请选择选项。');
			return false;
		}
		$.dialog({title:'产品添加',content:'url:/admin/BoxSend/addproductMuch/orderid/'+str,width:'700px',height:'400px',
		init: function () {
			this.max();
		},

		close: function(){
			this.reload();
		},
		ok: function(){
			this.reload();
		}
		});
	}

	function editSendInfo(orderid){
		$.dialog({title:'订单发送信息管理',content: 'url:/admin/BoxSend/editOrderSendInfo/orderid/'+orderid,width:'500px',height:'400px',
		close: function(){
			this.reload();
		},
		ok: function(){
			this.reload();
		}
		});
	}

	//批量清空订单的产品数据
	function clearOrderProductInfoMuch(){
		$.post(
		"/admin/BoxSend/clearOrderProductinfo",
		$("#orderlist").serialize(),
		function(result){
			alert(result.info);
			window.location.href='__SELF__';
		},
		" json"
		);
	}
</script>
		
		
		</td>
        <td width="9" background="__PUBLIC__/images/tab_16.gif">&nbsp;</td>
      </tr>
   <tr>
        <td colspan="10">
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;全选：<input type="checkbox" value="全选" id="allSelect" name="allSelect">&nbsp;&nbsp;
        <input type="button"  onclick="addproductMuch();" value="批量添加产品"/><span style="color:red;">P.S.:对于查询出来的订单，批量添加产品。(如有分页，仅对当前页有效)</span>
        <input type="button" onclick="if(confirm('确认要批量清空订单中的产品信息吗?')) clearOrderProductInfoMuch();" value="批量清空订单数据"/>
        </td>
      </tr>
    </table></td>
  </tr>
  <tr>
    <td height="29"><table width="100%" border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td width="15" height="29"><img src="__PUBLIC__/images/tab_20.gif" width="15" height="29" /></td>
        <td background="__PUBLIC__/images/tab_21.gif"><table width="100%" border="0" cellspacing="0" cellpadding="0">
          <tr>
            <td width="25%" height="29" nowrap="nowrap"><span class="STYLE1">{$page}</span></td>
            <td width="75%" valign="top" class="STYLE1"></td>
          </tr>
        </table></td>
        <td width="14"><img src="__PUBLIC__/images/tab_22.gif" width="14" height="29" /></td>
      </tr>
    </table></td>
  </tr>
</table>
	<script>
	function editAddress(ordernmb,userid,address_id){
		$.ajax({
			url:"{:u('BoxSend/getaddress')}",
			type:"post",
			dataType:"json",
			data:"userid="+userid+'&n='+Math.random(),
			success: function(chkresult){
				if(parseInt(chkresult.status)==1){
					var data=chkresult.data;
					var str='';

					for(var i in data){
						if(data[i]['id']==address_id){
							str+="<input type='radio' name='address' checked=checked value='"+data[i]['id']+"' style='border:0px'/>"+" "+data[i]['linkman']+" "+data[i]['telphone']+" "+data[i]['province']+" "+data[i]['city']+" "+data[i]['district']+" "+data[i]['address']+" "+data[i]['postcode']+"<br/><br/>";
						}else{
							str+="<input type='radio' name='address' value='"+data[i]['id']+"' style='border:0px'/>"+" "+data[i]['linkman']+" "+data[i]['telphone']+" "+data[i]['province']+" "+data[i]['city']+" "+data[i]['district']+" "+data[i]['address']+" "+data[i]['postcode']+"<br/><br/>";
						}
					}

					var sstr='';
					sstr+="<form  method='post'>"+str;

					$.dialog({
						title:'修改地址',
						content: sstr,
						ok:function(){
							send(ordernmb)
						},
						cancel: true
					});
				}
			}
		})
	}

	function send(ordernmb){
		var addm= $("input[@type=radio][name=address][checked]").val();
		if(addm!=null){
			$.ajax({
				url:"{:U('BoxSend/getaddress')}",
				type:"post",
				dataType:"json",
				data:"uid="+addm+"&ordernmb="+ordernmb+'&n='+Math.random(),
				success: function(chkresult){
					if(parseInt(chkresult.status)==1){
						alert('修改成功!');
						location.reload();
					}else{
						alert('修改失败!');
					}
				}
			})
		}
	}

	$("#allSelect").click(function(){
		var obj =$("input[id='listcheckbox']:not(:disabled)");
		if($(this).is(':checked')){
			obj.each(function(){
				$(this).attr('checked',true);
			});
		}else{
			obj.each(function(){
				$(this).attr('checked',false);
			});
		}
	});

	$("input[id='listcheckbox']:not(:disabled)").click(function(){
		var obj = $("input[id='listcheckbox']:not(:disabled):not(:checked)");
		if(obj.length){
			$("#allSelect").attr('checked',false);
		}else{
			$("#allSelect").attr('checked',true);
		}
	});

	var k="{$Think.get.boxid}";
	var resour="{$Think.get.resour}";
	var frominfo = "{$Think.get.frominfo}";
	if(resour){
		$("select[name='resour']").val(resour);
	}

	if(frominfo){
		change("{$Think.get.resour}","{$Think.get.frominfo}");
	}

	if(k){
		$("select[name='boxid']").val(k);
	}

	function change(value,param){
		if(value != ''){
			$.ajax({
				url:"__URL__/returnOrderResour",
				type:"post",
				dataType:"json",
				data:'fromid='+value,
				success: function(chkresult){
					if(parseInt(chkresult.status)==1){
						var data = chkresult.data;
						$("select[name='frominfo'] option:gt(0)").remove();
						if(data != null){
							for(var i in data){
								$("select[name='frominfo']").append("<option value='"+data[i].frominfo+"'>"+data[i].frominfo+"</option>");
							}
						}

						if(param != '' || param != 'undefined'){
							$("select[name='frominfo']").val(param);
						}
					}
				}
			})
		}else{
			$("select[name='frominfo'] option:gt(0)").remove();
		}
	}

	//切换订单状态
	function changepaystatus(obj,ordernum){

		var val = $(obj).next("input:hidden");
		
		if(val.val() == 1){
			if(!confirm("您确定设置为已退款么?")){
				return false;
			}
		}else if(val.val() ==2){
			if(!confirm("您确定设置为已付款么?")){
				return false;
			}
		}else{
			alert("此状态不可修改!");
			return false;
		}
		
		var value = val.val()==1?2:1;
		$.post("__URL__/changeState",{action:'changestate',val:value,ordernum:ordernum},function(ret){
			ret.data==1?$(obj).html('<font color="red">已付款</font>'):$(obj).html('<font color="#000080">已退款</font>');
			val.val(ret.data);
		})	
	}
</script>
<include file="Public:footer" />